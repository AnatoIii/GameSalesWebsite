version: "3.3"
services:
    frontend:
        image: frontend
        container_name: frontend
        network_mode: "host"
        ports: 
            - 80:80
        build:
            context: ./game-sales-tracker
    
    rabbitmq:
        image: rabbitmq:3-management
        container_name: rabbitmq
        network_mode: "host"
        ports:
            - 5672:5672
            - 15672:15672

    db:
        image: postgres:11
        container_name: postgres
        network_mode: "host"
        ports:
            - 5433:5432
        environment:
            POSTGRES_PASSWORD: salespassword
            POSTGRES_USER: salesservice
            PGDATA : /var/lib/postgresql/data
        volumes:
            - data:/var/lib/postgresql/data

    ps-parser:
        image: ps-parser
        container_name: ps-parser
        depends_on: 
            - rabbitmq
        build: 
            context: ./Parsers/
            dockerfile: ./PSStoreParser/Dockerfile
        volumes: 
            - configs:/configs

    steam-parser:
        image: steam-parser
        container_name: steam-parser
        depends_on: 
            - rabbitmq
        build: 
            context: ./Parsers/
            dockerfile: ./SteamParser/Dockerfile
        volumes: 
            - configs:/configs

    uplay-parser:
        image: uplay-parser
        container_name: uplay-parser
        depends_on: 
            - rabbitmq
        build: 
            context: ./Parsers/
            dockerfile: ./UplayParser/Dockerfile
        volumes: 
            - configs:/configs

    gateway-api:
        image: gateway-api
        container_name: gateway-api
        ports: 
            - 5443:443
            - 5080:80
        depends_on: 
            - db
        build: 
            context: ./GameSalesApi/
            dockerfile: ./GameSalesApi/Dockerfile
        volumes: 
            - configs:/configs

    games-saver:
        image: games-saver
        container_name: games-saver
        depends_on: 
            - db
            - rabbitmq
        build: 
            context: ./GamesServices/
            dockerfile: ./GamesSaver/Dockerfile
        environment:
            - queueSettings__connectionString=amqp://gamesservice:testpwd@rabbitmq:5672/
            - queueSettings__exchangeName=gameEntries
            - queueSettings__queueName=gameEntries
        volumes: 
            - configs:/configs

    games-provider:
        image: games-provider
        container_name: games-provider
        ports: 
            - 6443:443
            - 6080:80
        depends_on: 
            - db
        build: 
            context: ./GamesServices/
            dockerfile: ./GamesProvider/Dockerfile
        volumes: 
            - configs:/configs
    
volumes: 
    configs:
        external: true
    data: 
        driver: local
